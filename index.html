<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scheduled Institutional Forex Signals & History</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- Lucide Icons for visual elements -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Base styles for dark theme */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark Theme Background */
            color: #c9d1d9;
        }
        /* Custom styling for the Conviction Gauge */
        .gauge-container {
            width: 100%;
            height: 12px;
            background: #21262d; 
            border-radius: 9999px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.6);
        }
        .gauge-fill {
            height: 100%;
            transition: width 1s ease-out, background-color 0.5s ease-out;
            border-radius: 9999px;
        }
        .card-shadow {
            box-shadow: 0 6px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -4px rgba(0, 0, 0, 0.5);
        }
        .status-icon-tp { background-color: #10b981; } /* Green */
        .status-icon-sl { background-color: #ef4444; } /* Red */
        .status-icon-running { background-color: #f59e0b; } /* Yellow */
        .status-icon-replaced { background-color: #3b82f6; } /* Blue */
        
        /* Login Screen Gradient */
        .login-bg-gradient {
            background: linear-gradient(135deg, #1f2937 0%, #0d1117 100%);
        }

        /* Sidebar specifics */
        #sidebar {
            transition: transform 0.3s ease-in-out, width 0.3s ease-in-out;
            background-color: #161b22;
            border-right: 1px solid #21262d;
        }
        /* Mobile: Hidden by default */
        @media (max-width: 1023px) {
            #sidebar {
                position: fixed;
                top: 0;
                left: 0;
                width: 85%;
                max-width: 320px;
                height: 100vh;
                z-index: 50;
                transform: translateX(-100%);
            }
            #sidebar.open {
                transform: translateX(0);
            }
        }
        /* Desktop: Fixed width */
        @media (min-width: 1024px) {
            #sidebar {
                width: 300px;
                flex-shrink: 0;
                transform: translateX(0) !important;
            }
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Firebase Initialization and Utility Functions -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, setLogLevel, updateDoc, collection, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('debug'); // Enable Firestore logging

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        
        // Global environment variables (must be present)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Global State for the Application
        window.appState = {
            mt4Account: null,
            mt5Account: null,
            serverLists: { mt4: [], mt5: [] },
            isAuthenticated: false,
            allSignals: [],
            // New state for LLM outputs
            sentimentSummaryText: 'Click "âœ¨ Summarize Market Sentiment" to generate the latest macro analysis.',
            isAudioAvailable: false,
            currentAudioUrl: null,
        };

        // --- GEMINI API UTILITIES & CONFIG ---
        const API_KEY = ""; // Provided by Canvas environment
        
        // Text Generation Model URL (for analysis)
        const FLASH_API_MODEL = "gemini-2.5-flash-preview-09-2025";
        const FLASH_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${FLASH_API_MODEL}:generateContent`;

        // TTS Model URL (for audio briefing)
        const TTS_API_MODEL = "gemini-2.5-flash-preview-tts";
        const TTS_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${TTS_API_MODEL}:generateContent`;


        // --- TTS Helper Functions (PCM to WAV conversion) ---

        // Function to convert base64 data to ArrayBuffer
        const base64ToArrayBuffer = (base64) => {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        };

        // Helper function for writing strings to DataView
        const writeString = (view, offset, string) => {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        };

        // Function to convert PCM audio data into a WAV Blob
        const pcmToWav = (pcm16, sampleRate = 16000) => {
            // 16-bit signed PCM, 1 channel
            const numChannels = 1;
            const bitDepth = 16;
            const bytesPerSample = bitDepth / 8;
            const byteRate = sampleRate * numChannels * bytesPerSample;
            
            // Total size of the PCM data
            const pcmDataSize = pcm16.length * bytesPerSample;
            // Total file size: 44 bytes (header) + pcmDataSize
            const fileSize = 44 + pcmDataSize;

            // Create the buffer for the WAV file
            const buffer = new ArrayBuffer(fileSize);
            const view = new DataView(buffer);

            let offset = 0;

            // RIFF identifier 'RIFF'
            writeString(view, offset, 'RIFF'); offset += 4;
            // File size (36 + data size)
            view.setUint32(offset, fileSize - 8, true); offset += 4;
            // RIFF type 'WAVE'
            writeString(view, offset, 'WAVE'); offset += 4;
            // Format chunk identifier 'fmt '
            writeString(view, offset, 'fmt '); offset += 4;
            // Format chunk length (16 for PCM)
            view.setUint32(offset, 16, true); offset += 4;
            // Sample format (1 for PCM)
            view.setUint16(offset, 1, true); offset += 2;
            // Number of channels
            view.setUint16(offset, numChannels, true); offset += 2;
            // Sample rate
            view.setUint32(offset, sampleRate, true); offset += 4;
            // Byte rate (sampleRate * numChannels * bytesPerSample)
            view.setUint32(offset, byteRate, true); offset += 4;
            // Block align (numChannels * bytesPerSample)
            view.setUint16(offset, numChannels * bytesPerSample, true); offset += 2;
            // Bit depth
            view.setUint16(offset, bitDepth, true); offset += 2;
            // Data chunk identifier 'data'
            writeString(view, offset, 'data'); offset += 4;
            // Data chunk size
            view.setUint32(offset, pcmDataSize, true); offset += 4;

            // Write PCM data
            for (let i = 0; i < pcm16.length; i++, offset += 2) {
                view.setInt16(offset, pcm16[i], true);
            }

            return new Blob([buffer], { type: 'audio/wav' });
        };


        // --- LLM API CALLS (Text Generation) ---
        
        /**
         * Fetches a response from the Gemini API with exponential backoff.
         * @param {string} userQuery - The main prompt for the LLM.
         * @param {string} systemPrompt - Instructions for the LLM's persona/behavior.
         * @param {boolean} useGrounding - Whether to use Google Search grounding.
         * @param {number} attempt - Current retry attempt.
         * @returns {Promise<{text: string, sources: Array<{uri: string, title: string}>}>}
         */
        const fetchLLMResponse = async (userQuery, systemPrompt, useGrounding = true, attempt = 0) => {
            const MAX_RETRIES = 5;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                tools: useGrounding ? [{ "google_search": {} }] : undefined,
            };

            try {
                const response = await fetch(`${FLASH_API_URL}?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    if (response.status === 429 && attempt < MAX_RETRIES) {
                        const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return fetchLLMResponse(userQuery, systemPrompt, useGrounding, attempt + 1);
                    }
                    throw new Error(`API request failed with status: ${response.status}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;

                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }
                    return { text, sources };

                } else {
                    throw new Error("Invalid response structure from Gemini API.");
                }

            } catch (error) {
                console.error("Gemini API Error:", error);
                return { text: `Error: Could not generate analysis. ${error.message}`, sources: [] };
            }
        };


        /**
         * Feature 1: Generates deep fundamental analysis for a single trading signal.
         */
        window.generateSignalAnalysis = async (signalId) => {
            const signal = window.appState.allSignals.find(s => s.id === signalId);
            if (!signal) {
                alertModal('Error', 'Signal data not found.');
                return;
            }

            const button = document.getElementById(`analyze-btn-${signalId}`);
            if (button) {
                button.disabled = true;
                button.innerHTML = '<i data-lucide="loader" class="w-4 h-4 mr-2 animate-spin"></i> Analyzing...';
                lucide.createIcons();
            }

            const systemPrompt = "You are a seasoned institutional forex analyst. Provide a deep, grounded, and concise analysis of the requested trading signal. Justify the direction (BUY/SELL) based on current macro factors, geopolitical events, and major economic data releases (like FOMC, NFP, CPI). Assume the SMC concepts (BOS, FVG, OB) are valid structural components, but focus your analysis on the *fundamental* reason the structure is holding or breaking. Format the output as a sharp, structured trading note.";
            
            const userQuery = `Provide a deep fundamental analysis for this trading signal: Pair: ${signal.pair}, Bias: ${signal.bias}, Timeframe: ${signal.timeframe}, R:R: ${signal.r}:1. The signal is based on an 'Order Block Mitigation' and 'Liquidity Sweep' structural concept. Justify the trade based on the latest fundamental and macro drivers relevant to this currency pair.`;

            const { text, sources } = await fetchLLMResponse(userQuery, systemPrompt, true);

            if (button) {
                button.disabled = false;
                button.innerHTML = '<i data-lucide="brain-circuit" class="w-4 h-4 mr-2"></i> âœ¨ Deep Dive Analysis';
                lucide.createIcons();
            }
            
            let sourceList = sources.length > 0 ? sources.map(s => `<li class="text-xs text-indigo-400 break-words"><a href="${s.uri}" target="_blank" class="hover:underline">${s.title}</a></li>`).join('') : '<li class="text-xs text-gray-500">No external sources cited.</li>';
            
            const modalContent = `
                <div class="space-y-4">
                    <p class="text-gray-300 whitespace-pre-wrap">${text}</p>
                    <div class="pt-4 border-t border-gray-700">
                        <p class="font-semibold text-sm text-sky-400 mb-2">Grounding Sources:</p>
                        <ul class="list-disc list-inside space-y-1 pl-4">${sourceList}</ul>
                    </div>
                </div>
            `;
            
            alertModal(`Institutional Analysis: ${signal.pair} ${signal.bias}`, modalContent, true);
        };

        /**
         * Feature 2: Generates a global market sentiment summary.
         */
        window.generateMarketSentiment = async () => {
            const container = document.getElementById('llm-sentiment-summary');
            const button = document.getElementById('sentiment-btn');
            const audioButtonContainer = document.getElementById('audio-briefing-container');

            // Reset state
            window.appState.isAudioAvailable = false;
            if (window.appState.currentAudioUrl) URL.revokeObjectURL(window.appState.currentAudioUrl);
            audioButtonContainer.innerHTML = '';


            if (button) {
                button.disabled = true;
                button.innerHTML = '<i data-lucide="loader" class="w-4 h-4 mr-2 animate-spin"></i> Generating Macro Summary...';
                lucide.createIcons();
            }
            container.innerHTML = `<p class="text-center text-gray-500 py-6"><i data-lucide="sun" class="w-5 h-5 mr-2 animate-pulse inline"></i> Fetching real-time market drivers...</p>`;

            const systemPrompt = "You are a market commentator for institutional investors. Provide a highly concise, three-paragraph summary of the current global market sentiment. Paragraph 1: Key Macro/Central Bank Events (e.g., Fed decisions, NFP). Paragraph 2: Major Geopolitical/Risk Drivers. Paragraph 3: Overall Directional Bias for major USD pairs (EURUSD, USDJPY, GBPUSD). Use a professional, slightly bearish/bullish tone as appropriate. Do not use bullets or markdown headings.";
            
            const userQuery = "Summarize the current global macro landscape and its impact on the forex market today, highlighting the most recent economic reports and risk sentiment.";

            const { text, sources } = await fetchLLMResponse(userQuery, systemPrompt, true);
            
            // Store the text for the TTS feature
            window.appState.sentimentSummaryText = text;

            if (button) {
                button.disabled = false;
                button.innerHTML = '<i data-lucide="trending-up" class="w-4 h-4 mr-2"></i> âœ¨ Summarize Market Sentiment';
                lucide.createIcons();
            }

            let sourceList = sources.length > 0 ? sources.map(s => `<li class="text-xs text-indigo-400 break-words"><a href="${s.uri}" target="_blank" class="hover:underline">${s.title}</a></li>`).join('') : '<li class="text-xs text-gray-500">No external sources cited.</li>';
            
            container.innerHTML = `
                <div class="space-y-4">
                    <p id="sentiment-text-output" class="text-gray-300 whitespace-pre-wrap leading-relaxed">${text}</p>
                    <div id="audio-briefing-container" class="pt-4 border-t border-gray-800">
                        <button id="play-audio-btn" onclick="window.requestAudioBriefing()" class="w-full py-2 rounded-lg font-bold text-sm text-white bg-pink-600 hover:bg-pink-700 transition duration-200 flex items-center justify-center">
                            <i data-lucide="volume-2" class="w-4 h-4 mr-2"></i>
                            âœ¨ Generate Audio Briefing
                        </button>
                    </div>
                    <div class="pt-4 border-t border-gray-800">
                        <p class="font-semibold text-sm text-sky-400 mb-2">Sources:</p>
                        <ul class="list-disc list-inside space-y-1 pl-4">${sourceList}</ul>
                    </div>
                </div>
            `;
            lucide.createIcons();
        };

        /**
         * Feature 3: Requests audio for the generated market sentiment text (TTS).
         */
        window.requestAudioBriefing = async () => {
            const button = document.getElementById('play-audio-btn');
            const textToSpeak = window.appState.sentimentSummaryText;
            
            if (!textToSpeak || textToSpeak.startsWith('Click')) {
                alertModal('Error', 'Please generate the market sentiment summary first.');
                return;
            }

            if (button) {
                button.disabled = true;
                button.innerHTML = '<i data-lucide="loader" class="w-4 h-4 mr-2 animate-spin"></i> Generating Audio...';
                lucide.createIcons();
            }

            try {
                // The TTS model works best with a clear instruction
                const fullPrompt = `Say the following market analysis in a professional and informative tone: ${textToSpeak}`;

                const payload = {
                    contents: [{
                        parts: [{ text: fullPrompt }]
                    }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: "Charon" } // Professional, Informative
                            }
                        }
                    },
                };

                const response = await fetch(`${TTS_API_URL}?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`TTS API failed with status: ${response.status}`);
                }

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    // 1. Get sample rate from mimeType (e.g., audio/L16;rate=16000)
                    const rateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = rateMatch ? parseInt(rateMatch[1], 10) : 16000;

                    // 2. Convert base64 to ArrayBuffer (PCM data)
                    const pcmData = base64ToArrayBuffer(audioData);
                    
                    // 3. Convert ArrayBuffer (raw PCM16) to Int16Array
                    const pcm16 = new Int16Array(pcmData);

                    // 4. Convert PCM to WAV Blob
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    
                    // 5. Create URL and play audio
                    if (window.appState.currentAudioUrl) URL.revokeObjectURL(window.appState.currentAudioUrl);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    window.appState.currentAudioUrl = audioUrl;

                    const audio = new Audio(audioUrl);
                    audio.play();

                    // Update UI for playback
                    button.innerHTML = '<i data-lucide="volume-x" class="w-4 h-4 mr-2"></i> Playing Briefing...';
                    
                    audio.onended = () => {
                        button.innerHTML = '<i data-lucide="volume-2" class="w-4 h-4 mr-2"></i> âœ¨ Replay Audio Briefing';
                        button.disabled = false;
                        lucide.createIcons();
                    };
                } else {
                    throw new Error("Invalid audio response from TTS API.");
                }

            } catch (error) {
                console.error("TTS Audio Error:", error);
                alertModal('Audio Generation Failed', `Could not generate audio briefing. ${error.message}`);
                button.disabled = false;
                button.innerHTML = '<i data-lucide="volume-x" class="w-4 h-4 mr-2"></i> Audio Failed';
            }
            lucide.createIcons();
        };


        // --- FIRESTORE LISTENERS & DATA MANAGEMENT ---

        // 1. Listen for Public Server Lists (Must run as soon as 'db' is available and auth is complete)
        const setupServerListener = () => {
            if (!db) {
                console.warn("DB not initialized yet, cannot set up server listener.");
                return;
            }

            // Path for public data
            const serverListPath = doc(db, 'artifacts', appId, 'public', 'data', 'broker_servers', 'lists');

            onSnapshot(serverListPath, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    window.appState.serverLists.mt4 = data.mt4Servers || [];
                    window.appState.serverLists.mt5 = data.mt5Servers || [];
                    const lastUpdated = data.lastUpdated || 'N/A';
                    const elem = document.getElementById('last-server-update');
                    if(elem) elem.textContent = `Last update: ${lastUpdated}`;
                    updateServerDropdowns();
                } else {
                    // Set initial default servers if none exist
                    setDoc(serverListPath, {
                        mt4Servers: ['Broker A-Demo', 'Broker A-Live', 'Broker B-Live'],
                        mt5Servers: ['Broker X-Demo', 'Broker X-Live', 'Broker Y-Live'],
                        lastUpdated: new Date().toLocaleTimeString(),
                    }, { merge: true }).catch(console.error);
                }
            }, (error) => {
                console.error("Error fetching server list:", error);
            });
        };

        // 2. Listen for User Account Connections (MT4/MT5 - Requires resolved userId)
        const setupAccountListeners = () => {
            if (!userId || !db) return;
            
            // Define document paths for private user data
            const mt4Path = doc(db, 'artifacts', appId, 'users', userId, 'accounts', 'mt4');
            const mt5Path = doc(db, 'artifacts', appId, 'users', userId, 'accounts', 'mt5');

            onSnapshot(mt4Path, (docSnapshot) => {
                window.appState.mt4Account = docSnapshot.exists() ? docSnapshot.data() : null;
                renderAccountStatus('mt4');
            }, (error) => console.error("Error fetching MT4 account:", error));

            onSnapshot(mt5Path, (docSnapshot) => {
                window.appState.mt5Account = docSnapshot.exists() ? docSnapshot.data() : null;
                renderAccountStatus('mt5');
            }, (error) => console.error("Error fetching MT5 account:", error));
        };
        
        // --- FIREBASE INITIALIZATION AND AUTH ---
        if (Object.keys(firebaseConfig).length > 0) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Listen for AUTH state changes first
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    // Start public listener now that we have a secure context
                    setupServerListener(); 
                    // Start private listeners
                    setupAccountListeners(); 
                } else {
                    // Fallback UUID if token sign-in fails, but we still need to try to fetch public data
                    userId = crypto.randomUUID();
                    // Attempt to fetch public data
                    setupServerListener(); 
                }
                
                isAuthReady = true;
                window.appState.isAuthenticated = true;
                renderApp(); // Render the dashboard after auth is resolved
            });

            const authenticate = async () => {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase Auth Error:", error);
                }
            };
            authenticate();
        } else {
            console.warn("Firebase configuration not found. Running in UI simulation mode.");
            // In simulation mode, assume auth is ready quickly and render immediately
            isAuthReady = true;
            userId = crypto.randomUUID();
            window.appState.isAuthenticated = true;
            setTimeout(renderApp, 500); 
        }


        // --- MT4/MT5 Server Uploader and Connection Logic ---
        window.handleFileUpload = async (event, platform) => {
            const file = event.target.files[0];
            if (!file) return;
            if (!db || !userId) {
                alertModal('Error', 'Application is still initializing. Please wait and try again.');
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                const newServers = text.split('\n')
                                    .map(line => line.trim())
                                    .filter(line => line.length > 0);

                if (newServers.length === 0) {
                    alertModal('Upload Failed', 'The uploaded file was empty or contained no valid server names.');
                    return;
                }

                try {
                    const dataToUpdate = {
                        [`${platform}Servers`]: newServers,
                        lastUpdated: new Date().toLocaleTimeString(),
                    };
                    // Ensure serverListPath is available (db is guaranteed here)
                    const serverListPath = doc(db, 'artifacts', appId, 'public', 'data', 'broker_servers', 'lists');
                    await setDoc(serverListPath, dataToUpdate, { merge: true });
                    alertModal('Success', `${newServers.length} new ${platform.toUpperCase()} servers uploaded.`);
                } catch (error) {
                    console.error("Error updating server list:", error);
                    alertModal('Upload Error', 'Failed to update server list in Firestore. Check permissions.');
                }
            };
            reader.readAsText(file);
        };

        window.handleConnection = async (event, platform) => {
            event.preventDefault();
            if (!db || !userId) {
                alertModal('Error', 'Application is still initializing. Please wait and try again.');
                return;
            }
            
            const form = event.target;
            const data = Object.fromEntries(new FormData(form).entries());
            
            // === CRITICAL SECURITY FIX: DO NOT SAVE PASSWORD ===
            delete data.password; 
            // =================================================

            // Simulate connection success/failure
            const success = Math.random() > 0.1; 
            const status = success ? 'Connected' : 'Failed';
            
            const newAccountData = {
                broker: data.brokerName,
                server: data.serverName,
                loginId: data.loginId,
                type: data.accountType,
                status: status,
                balance: success ? (Math.random() * 5000 + 1000).toFixed(2) : '0.00',
                equity: success ? (Math.random() * 5000 + 1000).toFixed(2) : '0.00',
                leverage: success ? (Math.random() > 0.5 ? '1:100' : '1:500') : 'N/A',
                ping: success ? Math.floor(Math.random() * 80 + 20) : 'N/A',
                lastConnect: new Date().toLocaleTimeString(),
            };

            if (db && userId) {
                const accountPath = doc(db, 'artifacts', appId, 'users', userId, 'accounts', platform);
                try {
                    await setDoc(accountPath, newAccountData, { merge: true });
                    alertModal('Connection Result', `${platform.toUpperCase()} connection attempt: ${status}. Data saved.`);
                } catch (error) {
                    console.error("Error saving account data:", error);
                    alertModal('Error', 'Failed to save connection data to Firestore. Check user permissions.');
                }
            } else {
                 alertModal('Connection Result (Simulated)', `${platform.toUpperCase()} connection attempt: ${status}. (Not saved to Firestore - Check config/auth)`);
            }
        };

        // --- DASHBOARD SIGNAL LOGIC (Keep existing functionality) ---
        const REFRESH_INTERVAL_MS = 10800000; // 3 hours
        const PAIRS = ['XAUUSD', 'EURUSD', 'GBPUSD', 'AUDJPY', 'USDCAD', 'NZDUSD'];
        const TIMEFRAMES = ['H4', 'D1'];
        const generateUUID = () => crypto.randomUUID();

        const STATUS = {
            TP: { icon: 'ðŸŸ¢ TP', color: 'status-icon-tp', explanation: 'Price hit the Take Profit zone. Target achieved.' },
            SL: { icon: 'ðŸ”´ SL', color: 'status-icon-sl', explanation: 'Price hit the Stop Loss level. Structure violated.' },
            RUNNING: { icon: 'ðŸŸ¡ Running', color: 'status-icon-running', explanation: 'Trade is currently active, no target or stop reached yet.' },
            REPLACED: { icon: 'ðŸ”µ Old Signal', color: 'status-icon-replaced', explanation: 'Market structure (BOS/CHoCH) shifted, invalidating this trade.' }
        };

        const getConvictionColor = (score) => {
            if (score >= 90) return 'bg-green-500';
            if (score >= 80) return 'bg-yellow-500';
            return 'bg-red-500';
        };

        const generateSignal = () => {
            const pair = PAIRS[Math.floor(Math.random() * PAIRS.length)];
            const bias = Math.random() > 0.5 ? 'BUY' : 'SELL';
            const tf = TIMEFRAMES[Math.floor(Math.random() * TIMEFRAMES.length)];
            
            const slPips = Math.round(Math.random() * 30 + 50); 
            const rFactor = Math.random() * 7 + 8; 
            const tpPips = Math.round(slPips * rFactor); 
            const rRatio = (tpPips / slPips).toFixed(1);
            const conviction = Math.floor(Math.random() * 15) + 85; 

            const isJPY = pair.includes('JPY');
            const isXAU = pair.includes('XAU');
            const precision = isXAU ? 2 : (isJPY ? 3 : 5);
            const pipsFactor = isXAU ? 100 : (isJPY ? 100 : 10000); 
            const pipsUnit = 1 / pipsFactor;

            let entryBase;
            if (isXAU) entryBase = Math.random() * 100 + 2300; 
            else if (isJPY) entryBase = Math.random() * 5 + 150; 
            else entryBase = Math.random() * 0.05 + 1.1; 

            const entryPrice = parseFloat(entryBase.toFixed(precision));
            let slLevel, tpLevel;
            
            if (bias === 'BUY') {
              slLevel = (entryPrice - slPips * pipsUnit).toFixed(precision);
              tpLevel = (entryPrice + tpPips * pipsUnit).toFixed(precision);
            } else { // SELL
              slLevel = (entryPrice + slPips * pipsUnit).toFixed(precision);
              tpLevel = (entryPrice - tpPips * pipsUnit).toFixed(precision);
            }
            
            const factors = ['Order Block Mitigation', 'Fair Value Gap Fill', 'Deep Discount Zone Entry', 'Liquidity Sweep Confirmation', 'Successful Breaker Block Retest'];
            const factor = factors[Math.floor(Math.random() * factors.length)];
            let explanation = '';
            if (bias === 'BUY') {
                explanation = `Confirmed Bullish BOS. Price mitigated the H4 ${factor}. Look for continuation toward Buy-Side Liquidity. Conviction is high due to Volatility Shift.`;
            } else {
                explanation = `Confirmed Bearish BOS. Price respected the D1 ${factor}. Expect FVG fill and a drop to sweep Sell-Side Liquidity. Conviction remains solid.`;
            }

            return {
                id: generateUUID(),
                pair,
                timeframe: tf,
                entry: entryPrice.toFixed(precision),
                stop_loss: slLevel,
                take_profit: tpLevel,
                conviction: conviction,
                bias: bias,
                r: rRatio,
                slPips: slPips,
                tpPips: tpPips,
                explanation: explanation,
                status: 'RUNNING', 
                time_created: new Date().toLocaleTimeString('en-US'),
                time_closed: null,
                close_explanation: null,
            };
        };
        
        const checkSignalStatus = (signal) => {
            let tpChance = signal.conviction / 100; 
            const outcomeRoll = Math.random();

            if (outcomeRoll < tpChance * 0.6) { 
                return 'TP';
            } else if (outcomeRoll < tpChance * 0.9) { 
                return 'SL';
            } else {
                return 'RUNNING';
            }
        };

        const checkMarketCondition = () => {
            return Math.random() < 0.3; 
        };

        const renderCurrentSignals = (signals) => {
            const container = document.getElementById('current-signals-container');
            const activeSignals = signals.filter(s => s.status === 'RUNNING');
            
            if (!container) return; // Guard clause for when we are on the login screen

            if (activeSignals.length === 0) {
                 container.innerHTML = '<p class="text-gray-500 italic md:col-span-4">No high-quality signals available in the current market cycle. Waiting for a BOS/CHoCH.</p>';
                 return;
            }

            container.innerHTML = activeSignals.map(signal => {
                const isBuy = signal.bias === 'BUY';
                const biasColor = isBuy ? 'text-green-500' : 'text-red-500';
                const bgColor = isBuy ? 'bg-green-500/10' : 'bg-red-500/10';
                const biasIcon = isBuy ? 'trending-up' : 'trending-down';
                const convictionColorClass = getConvictionColor(signal.conviction);

                const priceRow = (label, value, color) => `
                    <div class="flex justify-between items-center text-sm border-b border-gray-800 py-1 last:border-b-0">
                        <span class="text-gray-400 font-medium">${label}:</span>
                        <span class="${color} font-mono font-semibold tracking-wide">${value}</span>
                    </div>
                `;

                return `
                    <div class="card-shadow bg-[#161b22] border-2 border-yellow-600/50 rounded-xl overflow-hidden transition duration-300 relative">
                        <span class="absolute top-0 right-0 m-3 px-3 py-1 text-xs font-bold rounded-full ${STATUS.RUNNING.color} text-gray-900">${STATUS.RUNNING.icon}</span>

                        <!-- Header -->
                        <div class="p-4 border-b border-gray-800 ${bgColor}">
                            <div class="flex justify-between items-start">
                                <h2 class="text-2xl font-extrabold text-white flex items-center">
                                    <i data-lucide="${biasIcon}" class="w-5 h-5 mr-2 ${biasColor}"></i>
                                    <span>${signal.pair}</span>
                                </h2>
                                <span class="text-xs font-bold px-3 py-1 rounded-full ${isBuy ? 'bg-green-700 text-green-100' : 'bg-red-700 text-red-100'} shadow-md">
                                    ${signal.bias}
                                </span>
                            </div>
                            <div class="mt-1 flex justify-between items-center text-sm">
                                <span class="font-medium text-gray-500">TF: <span class="font-mono text-indigo-400">${signal.timeframe}</span></span>
                                <span class="font-medium text-gray-500">R:R: <span class="font-extrabold text-cyan-400">${signal.r}:1</span></span>
                            </div>
                        </div>

                        <!-- Details Section -->
                        <div class="p-4 space-y-3">
                            
                            <!-- Price Levels -->
                            <div class="bg-gray-800/50 p-3 rounded-lg">
                                ${priceRow('Entry Price', signal.entry, 'text-white text-lg')}
                                ${priceRow(`Stop Loss (${signal.slPips} pips)`, signal.stop_loss, 'text-red-400')}
                                ${priceRow(`Take Profit (${signal.tpPips} pips)`, signal.take_profit, 'text-green-400')}
                            </div>

                            <!-- Conviction Gauge -->
                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-sm font-medium text-gray-400 flex items-center">
                                        <i data-lucide="zap" class="w-4 h-4 mr-1 text-yellow-400"></i>
                                        Conviction Score
                                    </span>
                                    <span class="text-lg font-bold ${convictionColorClass.replace('bg', 'text')}">${signal.conviction}%</span>
                                </div>
                                <div class="gauge-container">
                                    <div class="gauge-fill ${convictionColorClass}" style="width: ${signal.conviction}%;"></div>
                                </div>
                            </div>

                            <!-- Explanation -->
                            <div class="text-xs pt-2">
                                <h4 class="font-semibold text-gray-300 mb-1 flex items-center">
                                    <i data-lucide="message-square" class="w-3 h-3 mr-1 text-sky-400"></i>
                                    Analysis Summary
                                </h4>
                                <p class="text-gray-400 italic leading-relaxed">${signal.explanation}</p>
                            </div>
                        </div>
                        
                        <!-- LLM Feature Button -->
                        <div class="p-4 pt-0">
                            <button id="analyze-btn-${signal.id}" onclick="window.generateSignalAnalysis('${signal.id}')" class="w-full py-2 rounded-lg font-bold text-sm text-white bg-pink-600 hover:bg-pink-700 transition duration-200 flex items-center justify-center">
                                <i data-lucide="brain-circuit" class="w-4 h-4 mr-2"></i>
                                âœ¨ Deep Dive Analysis
                            </button>
                        </div>

                        <div class="p-2 bg-gray-900 text-right text-xs text-gray-600 border-t border-gray-800">
                            Last Checked: ${signal.time_created}
                        </div>
                    </div>
                `;
            }).join('');
        };

        const renderPreviousSignals = (signals) => {
            const container = document.getElementById('previous-signals-container');
            if (!container) return;
            const previousSignals = signals.filter(s => s.status !== 'RUNNING').reverse(); 
            
            if (previousSignals.length === 0) {
                container.innerHTML = '<p id="no-previous-signals" class="text-gray-500 italic md:col-span-4">No previous signals tracked yet.</p>';
                return;
            }

            container.innerHTML = previousSignals.map(signal => {
                const finalResult = STATUS[signal.status];
                
                const dataRow = (label, value, valueClass = 'text-gray-200') => `
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-gray-400">${label}:</span>
                        <span class="${valueClass} font-mono font-medium">${value}</span>
                    </div>
                `;

                return `
                    <div class="card-shadow bg-[#161b22] border border-gray-800 rounded-xl p-4 transition duration-300 hover:border-gray-500 relative">
                        
                        <!-- Status Badge -->
                        <div class="absolute top-4 right-4 px-3 py-1 text-xs font-bold rounded-full ${finalResult.color} text-gray-900 shadow-md">
                            ${finalResult.icon}
                        </div>

                        <h3 class="text-xl font-extrabold text-white mb-3">
                            ${signal.pair} <span class="text-gray-500 text-sm font-normal">(${signal.timeframe})</span>
                        </h3>

                        <div class="space-y-1 mb-3">
                            ${dataRow('Entry Price', signal.entry, 'text-indigo-400')}
                            ${dataRow('SL', signal.stop_loss, 'text-red-400')}
                            ${dataRow('TP', signal.take_profit, 'text-green-400')}
                        </div>

                        <div class="space-y-1 border-t border-b border-gray-800 py-3">
                            ${dataRow('Confidence Score', `${signal.conviction}%`, 'text-yellow-400')}
                            ${dataRow('Time Created', signal.time_created)}
                            ${dataRow('Time Closed', signal.time_closed || 'N/A')}
                        </div>

                        <div class="mt-3 text-xs">
                            <h4 class="font-semibold text-gray-300 mb-1">
                                Closing Note:
                            </h4>
                            <p class="text-gray-400 italic leading-relaxed">${signal.close_explanation || finalResult.explanation}</p>
                        </div>
                    </div>
                `;
            }).join('');
        };

        let signalInterval = null;

        const refreshDashboard = () => {
            if (!window.appState.isAuthenticated) return;

            const statusPanel = document.getElementById('analysis-status');
            if (!statusPanel) return;

            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US');
            const marketChanged = checkMarketCondition();
            
            let signalsToArchive = [];
            let signalsToKeepRunning = [];

            window.appState.allSignals.filter(s => s.status === 'RUNNING').forEach(signal => {
                const outcome = checkSignalStatus(signal);
                if (outcome === 'RUNNING') {
                    signal.time_created = timeString; 
                    signalsToKeepRunning.push(signal);
                } else {
                    signal.status = outcome;
                    signal.time_closed = timeString;
                    signal.close_explanation = STATUS[outcome].explanation;
                    signalsToArchive.push(signal);
                }
            });

            if (marketChanged || signalsToKeepRunning.length === 0) {
                signalsToKeepRunning.forEach(signal => {
                    signal.status = 'REPLACED';
                    signal.time_closed = timeString;
                    signal.close_explanation = STATUS.REPLACED.explanation;
                    signalsToArchive.push(signal);
                });
                signalsToKeepRunning = []; 
                
                const newSignals = [];
                for (let i = 0; i < 4; i++) {
                    newSignals.push(generateSignal());
                }
                
                window.appState.allSignals = [...window.appState.allSignals.filter(s => s.status !== 'RUNNING'), ...signalsToArchive, ...newSignals];

                statusPanel.className = 'font-medium text-lg text-red-400';
                statusPanel.innerHTML = `<i data-lucide="alert-triangle" class="inline w-5 h-5 mr-2"></i> NEW MARKET STRUCTURE DETECTED: ${newSignals.length} Fresh Signals Generated @ ${timeString}`;
            
            } else {
                window.appState.allSignals = [...window.appState.allSignals.filter(s => s.status !== 'RUNNING'), ...signalsToArchive, ...signalsToKeepRunning];

                statusPanel.className = 'font-medium text-lg text-green-400';
                statusPanel.innerHTML = `<i data-lucide="check-circle" class="inline w-5 h-5 mr-2"></i> MARKET CONTINUATION: Signals Maintained and Timestamps Refreshed @ ${timeString}`;
            }

            renderCurrentSignals(window.appState.allSignals);
            renderPreviousSignals(window.appState.allSignals);
            lucide.createIcons();
        };

        // --- UI RENDERING FUNCTIONS ---

        const alertModal = (title, message, isHtml = false) => {
            const modal = document.getElementById('custom-modal');
            const modalMessage = document.getElementById('modal-message');

            document.getElementById('modal-title').textContent = title;
            if (isHtml) {
                modalMessage.innerHTML = message;
            } else {
                modalMessage.textContent = message;
            }
            modal.classList.remove('hidden');
        };

        const closeModal = () => {
            document.getElementById('custom-modal').classList.add('hidden');
        };

        window.closeModal = closeModal;

        const renderAccountStatus = (platform) => {
            const account = window.appState[`${platform}Account`];
            const container = document.getElementById(`${platform}-account-status`);

            if (!container) return;

            if (!account || account.status === 'Failed') {
                container.innerHTML = `
                    <div class="p-3 rounded-lg bg-red-900/30 text-red-300 border border-red-700">
                        <p class="font-bold mb-1 flex items-center">
                            <i data-lucide="circle-x" class="w-4 h-4 mr-2"></i>
                            Not Connected
                        </p>
                        <p class="text-sm">Please enter credentials and click 'Connect Now'.</p>
                    </div>
                `;
            } else {
                const statusColor = account.status === 'Connected' ? 'bg-green-700/30 text-green-300 border-green-700' : 'bg-yellow-700/30 text-yellow-300 border-yellow-700';
                const icon = account.status === 'Connected' ? 'check-circle' : 'loader-2';
                
                container.innerHTML = `
                    <div class="p-3 rounded-lg ${statusColor} border">
                        <p class="font-bold mb-1 flex items-center">
                            <i data-lucide="${icon}" class="w-4 h-4 mr-2"></i>
                            Status: ${account.status}
                        </p>
                        <div class="text-sm space-y-1">
                            <p>Broker: <span class="font-semibold">${account.broker}</span></p>
                            <p>Balance: <span class="font-mono text-lg text-cyan-400">$${account.balance}</span></p>
                            <p>Equity: <span class="font-mono">$${account.equity}</span></p>
                            <p>Leverage: ${account.leverage}</p>
                            <p>Ping: ${account.ping} ms</p>
                        </div>
                    </div>
                `;
            }
            lucide.createIcons();
        };

        const updateServerDropdowns = () => {
            const platforms = ['mt4', 'mt5'];
            platforms.forEach(platform => {
                const dropdown = document.getElementById(`${platform}-server-name`);
                const currentCount = document.getElementById(`current-${platform}-servers`);
                
                if (dropdown) {
                    dropdown.innerHTML = '<option value="">Select Server</option>';
                    window.appState.serverLists[platform].forEach(server => {
                        const option = document.createElement('option');
                        option.value = server;
                        option.textContent = server;
                        dropdown.appendChild(option);
                    });
                }
                if (currentCount) {
                    currentCount.textContent = `Current ${platform.toUpperCase()} servers loaded: ${window.appState.serverLists[platform].length}`;
                }
            });
        };

        const toggleSidebar = () => {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('hidden');
        };
        window.toggleSidebar = toggleSidebar;

        // --- MAIN APP RENDERER ---
        const getDashboardHTML = () => `
            <div id="sidebar-overlay" class="fixed inset-0 bg-black/70 z-40 hidden lg:hidden" onclick="window.toggleSidebar()"></div>
            
            <div class="flex min-h-screen">
                <!-- Sidebar (MT4/MT5 Connection & Uploader) -->
                <div id="sidebar" class="z-50 p-4 lg:p-6 shadow-xl lg:shadow-none h-full overflow-y-auto">
                    <div class="flex justify-between items-center mb-6 lg:mb-8">
                        <h3 class="text-xl font-bold text-cyan-400">Account Manager</h3>
                        <button onclick="window.toggleSidebar()" class="lg:hidden p-2 text-gray-400 hover:text-white rounded-full">
                             <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>

                    <!-- User ID Display -->
                    <div class="mb-4 p-3 bg-gray-800 rounded-lg text-xs break-all">
                        <span class="text-gray-500 font-medium">User ID:</span>
                        <span class="font-mono text-indigo-400">${userId || 'N/A (Auth Error)'}</span>
                    </div>

                    <!-- MT4 Panel -->
                    <div class="mb-6 border border-gray-700 rounded-lg overflow-hidden">
                        <input type="checkbox" id="mt4-toggle" class="hidden peer" checked>
                        <label for="mt4-toggle" class="p-4 flex justify-between items-center cursor-pointer bg-gray-800 hover:bg-gray-700/50">
                            <h4 class="font-bold text-lg text-white flex items-center">
                                <i data-lucide="terminal" class="w-5 h-5 mr-2 text-sky-400"></i>
                                Connect MT4 Account
                            </h4>
                            <i data-lucide="chevron-down" class="w-5 h-5 text-gray-400 transition-transform duration-300 peer-checked:rotate-180"></i>
                        </label>
                        <div class="p-4 bg-[#161b22] peer-checked:block transition-all duration-300">
                            <div id="mt4-account-status" class="mb-4"></div>
                            <form onsubmit="window.handleConnection(event, 'mt4')" class="space-y-3">
                                <input type="text" name="brokerName" placeholder="Broker Name" required class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 text-white">
                                <select id="mt4-server-name" name="serverName" required class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 text-white">
                                    <!-- Options populated by JS -->
                                </select>
                                <input type="text" name="loginId" placeholder="Login ID" required class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 text-white">
                                <input type="password" name="password" placeholder="Password" required class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 text-white">
                                <select name="accountType" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 text-white">
                                    <option value="Demo">Demo</option>
                                    <option value="Live">Live</option>
                                </select>
                                <button type="submit" class="w-full py-2 rounded-lg font-bold text-white bg-indigo-600 hover:bg-indigo-700 transition duration-200">
                                    Connect Now
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- MT5 Panel -->
                    <div class="mb-6 border border-gray-700 rounded-lg overflow-hidden">
                        <input type="checkbox" id="mt5-toggle" class="hidden peer">
                        <label for="mt5-toggle" class="p-4 flex justify-between items-center cursor-pointer bg-gray-800 hover:bg-gray-700/50">
                            <h4 class="font-bold text-lg text-white flex items-center">
                                <i data-lucide="terminal-square" class="w-5 h-5 mr-2 text-emerald-400"></i>
                                Connect MT5 Account
                            </h4>
                            <i data-lucide="chevron-down" class="w-5 h-5 text-gray-400 transition-transform duration-300 peer-checked:rotate-180"></i>
                        </label>
                        <div class="p-4 bg-[#161b22] peer-checked:block transition-all duration-300 hidden">
                            <div id="mt5-account-status" class="mb-4"></div>
                            <form onsubmit="window.handleConnection(event, 'mt5')" class="space-y-3">
                                <input type="text" name="brokerName" placeholder="Broker Name" required class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 text-white">
                                <select id="mt5-server-name" name="serverName" required class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 text-white">
                                    <!-- Options populated by JS -->
                                </select>
                                <input type="text" name="loginId" placeholder="Login ID" required class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 text-white">
                                <input type="password" name="password" placeholder="Password" required class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 text-white">
                                <select name="accountType" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-700 text-white">
                                    <option value="Demo">Demo</option>
                                    <option value="Live">Live</option>
                                </select>
                                <button type="submit" class="w-full py-2 rounded-lg font-bold text-white bg-indigo-600 hover:bg-indigo-700 transition duration-200">
                                    Connect Now
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Server Auto-Uploader Panel -->
                    <div class="mb-6 border border-gray-700 rounded-lg overflow-hidden">
                        <input type="checkbox" id="uploader-toggle" class="hidden peer">
                        <label for="uploader-toggle" class="p-4 flex justify-between items-center cursor-pointer bg-gray-800 hover:bg-gray-700/50">
                            <h4 class="font-bold text-lg text-white flex items-center">
                                <i data-lucide="cloud-upload" class="w-5 h-5 mr-2 text-yellow-400"></i>
                                Server Auto-Uploader
                            </h4>
                            <i data-lucide="chevron-down" class="w-5 h-5 text-gray-400 transition-transform duration-300 peer-checked:rotate-180"></i>
                        </label>
                        <div class="p-4 bg-[#161b22] peer-checked:block transition-all duration-300 hidden space-y-4 text-sm">
                            <p class="text-gray-400">Upload a TXT or CSV file containing one server name per line to update the dropdown lists for all users.</p>
                            
                            <div class="space-y-2 p-3 bg-gray-900 rounded-lg">
                                <p id="current-mt4-servers" class="text-sm font-medium text-indigo-300">Current MT4 servers loaded: 0</p>
                                <label class="block text-gray-300">MT4 Server List (.txt/.csv)</label>
                                <input type="file" onchange="window.handleFileUpload(event, 'mt4')" accept=".csv, .txt" class="w-full text-xs text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                            </div>

                            <div class="space-y-2 p-3 bg-gray-900 rounded-lg">
                                <p id="current-mt5-servers" class="text-sm font-medium text-emerald-300">Current MT5 servers loaded: 0</p>
                                <label class="block text-gray-300">MT5 Server List (.txt/.csv)</label>
                                <input type="file" onchange="window.handleFileUpload(event, 'mt5')" accept=".csv, .txt" class="w-full text-xs text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100">
                            </div>

                            <p id="last-server-update" class="text-xs text-gray-500 pt-2 border-t border-gray-700"></p>
                        </div>
                    </div>
                </div>

                <!-- Main Content (Dashboard) -->
                <main class="flex-1 p-4 sm:p-8 overflow-x-hidden">
                    <header class="text-center mb-10 pb-4 border-b border-gray-700 flex justify-between items-center">
                        <button onclick="window.toggleSidebar()" class="lg:hidden p-2 text-gray-400 hover:text-white rounded-lg bg-[#161b22]">
                            <i data-lucide="menu" class="w-6 h-6"></i>
                        </button>
                        <h1 class="text-4xl sm:text-5xl font-extrabold text-cyan-400 flex items-center justify-center flex-1">
                            <i data-lucide="scan-eye" class="w-8 h-8 sm:w-10 sm:h-10 mr-3 text-indigo-400"></i>
                            SMC Signal Dashboard & History
                        </h1>
                    </header>

                    <!-- Status Panel (Now includes LLM Sentiment Button) -->
                    <div id="status-panel" class="mb-8 p-4 bg-[#161b22] border border-gray-800 rounded-lg text-sm transition duration-500">
                        <p id="analysis-status" class="font-medium text-gray-400">Initializing...</p>
                        
                        <div class="mt-4 pt-4 border-t border-gray-800">
                            <button id="sentiment-btn" onclick="window.generateMarketSentiment()" class="w-full py-2 rounded-lg font-bold text-sm text-white bg-sky-600 hover:bg-sky-700 transition duration-200 flex items-center justify-center">
                                <i data-lucide="trending-up" class="w-4 h-4 mr-2"></i>
                                âœ¨ Summarize Market Sentiment
                            </button>
                        </div>
                    </div>
                    
                    <!-- LLM Sentiment Output Area -->
                    <div class="mb-8 p-6 bg-gray-900 border border-sky-700 rounded-xl shadow-lg">
                        <h2 class="text-xl font-bold text-white mb-3 flex items-center border-b border-gray-800 pb-2">
                             <i data-lucide="sun" class="w-5 h-5 mr-2 text-sky-400"></i>
                            Global Macro Outlook (AI Generated)
                        </h2>
                        <div id="llm-sentiment-summary" class="text-sm text-gray-400 italic">
                            ${window.appState.sentimentSummaryText}
                        </div>
                    </div>


                    <!-- Current Signals Section -->
                    <h2 class="text-3xl font-bold text-white mb-6 border-b border-gray-700 pb-2">
                        Current 4 Signals
                    </h2>
                    <div id="current-signals-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
                        <!-- Current signals will be injected here -->
                    </div>

                    <!-- Previous Signals Section -->
                    <h2 class="text-3xl font-bold text-white mb-6 border-b border-gray-700 pb-2 flex items-center">
                        Previous Signals Archive 
                        <i data-lucide="archive" class="w-6 h-6 ml-3 text-gray-500"></i>
                    </h2>
                    <div id="previous-signals-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        <!-- Previous signals will be injected here -->
                        <p id="no-previous-signals" class="text-gray-500 italic md:col-span-4">No previous signals tracked yet.</p>
                    </div>
                </main>
            </div>
        `;

        const renderApp = () => {
            const root = document.getElementById('app-root');
            if (!isAuthReady) {
                 // Prevent rendering until auth state is resolved
                root.innerHTML = '<div class="min-h-screen flex items-center justify-center text-xl text-gray-400">Loading Application...</div>';
                return;
            }

            if (window.appState.isAuthenticated) {
                // Render Dashboard
                root.innerHTML = getDashboardHTML();
                
                // Initialize MT4/MT5 forms
                renderAccountStatus('mt4');
                renderAccountStatus('mt5');
                updateServerDropdowns();
                
                // Start signal generation/refresh loop
                if (signalInterval) clearInterval(signalInterval);
                refreshDashboard();
                signalInterval = setInterval(refreshDashboard, REFRESH_INTERVAL_MS);

            } else {
                // Render Login
                root.innerHTML = getLoginHTML();
            }
            lucide.createIcons();
        };

        const getLoginHTML = () => `
            <div class="min-h-screen flex items-center justify-center login-bg-gradient p-4">
                <div class="w-full max-w-md bg-[#161b22] rounded-xl p-8 shadow-2xl border border-gray-800">
                    <div class="text-center mb-8">
                        <i data-lucide="scan-eye" class="w-12 h-12 text-indigo-400 mx-auto mb-2"></i>
                        <h1 class="text-3xl font-extrabold text-white">SMC Dashboard Login</h1>
                        <p class="text-gray-400 mt-1">Access your institutional trading signals</p>
                    </div>
                    <form id="login-form" onsubmit="window.handleLogin(event)">
                        <div class="space-y-4">
                            <div>
                                <label for="username" class="block text-sm font-medium text-gray-400 mb-1">Email or Username</label>
                                <input type="text" id="username" name="username" required class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 focus:ring-indigo-500 focus:border-indigo-500 text-white placeholder-gray-500">
                            </div>
                            <div>
                                <label for="password" class="block text-sm font-medium text-gray-400 mb-1">Password</label>
                                <input type="password" id="password" name="password" required class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 focus:ring-indigo-500 focus:border-indigo-500 text-white placeholder-gray-500">
                            </div>
                            <div class="flex justify-between items-center">
                                <a href="#" class="text-sm font-medium text-indigo-400 hover:text-indigo-300 transition duration-150">Forgot Password?</a>
                            </div>
                            <button type="submit" class="w-full py-3 rounded-lg font-bold text-white bg-indigo-600 hover:bg-indigo-700 transition duration-200 shadow-lg shadow-indigo-600/30">
                                Log In
                            </button>
                            <button type="button" class="w-full py-3 rounded-lg font-bold text-indigo-400 bg-gray-700/50 hover:bg-gray-700 transition duration-200 border border-indigo-500/50">
                                Create Account
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        
        window.handleLogin = (event) => {
            event.preventDefault();
            const form = event.target;
            const username = form.username.value;
            // In a real app, this would call Firebase signInWithEmailAndPassword.
            // Here, we simulate success and move to the dashboard.
            console.log(`Simulating login for: ${username}`);
            alertModal('Login Successful', `Welcome back, ${username}! Redirecting to dashboard.`);
            
            // Wait for modal close, then render the app
            setTimeout(() => {
                closeModal();
                window.appState.isAuthenticated = true;
                // Re-render the app to switch from login to dashboard
                renderApp(); 
            }, 1500);
        };

        // --- Custom Modal UI for Alerts (No alert() or confirm()) ---
        const modalHTML = `
            <div id="custom-modal" class="fixed inset-0 bg-black/70 z-[100] flex items-center justify-center hidden p-4">
                <div class="bg-[#161b22] p-6 rounded-xl max-w-xl w-full border border-gray-700 shadow-2xl overflow-y-auto max-h-[90vh]">
                    <h3 id="modal-title" class="text-xl font-bold text-white mb-3 border-b border-gray-700 pb-2">Alert</h3>
                    <div id="modal-message" class="text-gray-300 mb-6 leading-relaxed">Message content.</div>
                    <button onclick="window.closeModal()" class="w-full py-2 rounded-lg font-bold text-white bg-indigo-600 hover:bg-indigo-700 transition duration-200">
                        Close
                    </button>
                </div>
            </div>
        `;

        // --- Global Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            const root = document.createElement('div');
            root.id = 'app-root';
            document.body.appendChild(root);
            
            // We rely on onAuthStateChanged to call renderApp once authentication is ready.
            if (Object.keys(firebaseConfig).length === 0) {
                // If in simulation mode (no config), render app immediately after timeout
                renderApp(); 
            } else {
                 // Render a loading state until isAuthReady is true
                 renderApp(); 
            }
        });
        
    </script>
</body>
</html>
