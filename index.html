import React, { useState, useEffect, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot } from 'firebase/firestore';
import { Power, Signal, User, Server, Cpu, ArrowUp, ArrowDown, Repeat, Zap, Shield, Eye, Settings, LogOut, Loader2, Send, TrendingUp, TrendingDown } from 'lucide-react';

// --- Global Variables (Provided by Canvas Environment) ---
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// --- Firebase Initialization ---
let app;
let db;
let auth;

try {
  app = initializeApp(firebaseConfig);
  db = getFirestore(app);
  auth = getAuth(app);
} catch (error) {
  console.error("Firebase Initialization Error:", error);
}

// Helper to handle authentication and setup
const useFirebaseAuthState = () => {
  const [userId, setUserId] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);
  const [error, setError] = useState(null);

  useEffect(() => {
    if (!auth) {
      setError("Firebase Auth not initialized.");
      setIsAuthReady(true);
      return;
    }

    const signIn = async () => {
      try {
        if (initialAuthToken) {
          await signInWithCustomToken(auth, initialAuthToken);
        } else {
          await signInAnonymously(auth);
        }
      } catch (e) {
        console.error("Sign-in error:", e);
        setError("Failed to sign in. Please try refreshing.");
      }
    };

    const unsubscribe = onAuthStateChanged(auth, (user) => {
      if (user) {
        setUserId(user.uid);
      } else {
        setUserId(null);
        signIn(); // Try to sign in again if not authenticated
      }
      setIsAuthReady(true);
    });

    return () => unsubscribe();
  }, [initialAuthToken]);

  return { userId, isAuthReady, error, authInstance: auth };
};

// --- Signal Simulation and Core Logic Mock ---

// Pairs and Timeframes used for simulation
const PAIRS = ['EURUSD', 'GBPUSD', 'AUDUSD', 'USDJPY', 'USDCAD', 'NZDUSD'];
const TIMEFRAMES = ['M30', 'H1', 'H4'];

const generateMockSignals = (count = 3) => {
  const signals = [];
  for (let i = 0; i < count; i++) {
    const pair = PAIRS[Math.floor(Math.random() * PAIRS.length)];
    const tf = TIMEFRAMES[Math.floor(Math.random() * TIMEFRAMES.length)];
    const type = Math.random() > 0.5 ? 'BUY' : 'SELL';
    const strength = Math.floor(Math.random() * 50) + 50; // 50% to 99%
    const entry = (Math.random() * 0.05 + 1.1).toFixed(5);
    const fixedSL = 30; // 30 pips fixed SL
    const fixedTP = Math.random() > 0.5 ? 150 : 200; // 150-200 pips fixed TP

    // Calculate actual SL/TP levels based on entry and type
    let slLevel, tpLevel, rrRatio;
    if (type === 'BUY') {
      slLevel = (parseFloat(entry) - fixedSL / 10000).toFixed(5);
      tpLevel = (parseFloat(entry) + fixedTP / 10000).toFixed(5);
      rrRatio = (fixedTP / fixedSL).toFixed(1);
    } else { // SELL
      slLevel = (parseFloat(entry) + fixedSL / 10000).toFixed(5);
      tpLevel = (parseFloat(entry) - fixedTP / 10000).toFixed(5);
      rrRatio = (fixedTP / fixedSL).toFixed(1);
    }

    // Only filter high-probability trades (simulated by R:R >= 5.0)
    if (parseFloat(rrRatio) >= 5.0) {
      signals.push({
        id: crypto.randomUUID(),
        pair,
        tf,
        type,
        entry,
        sl: slLevel,
        tp: tpLevel,
        r: rrRatio,
        strength: strength,
        status: 'NEW', // NEW, EXECUTED, CONFIRMED, DENIED, HIT_TP, HIT_SL
        timestamp: new Date().toLocaleTimeString(),
      });
    }
  }
  return signals;
};

// --- Firestore Access Hooks ---

const MT4_SETTINGS_PATH = (userId) => `artifacts/${appId}/users/${userId}/settings/mt4_settings`;

const useMT4Settings = (userId, isAuthReady) => {
  const [settings, setSettings] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!isAuthReady || !userId || !db) {
      setLoading(false);
      return;
    }

    const docRef = doc(db, MT4_SETTINGS_PATH(userId));

    const unsubscribe = onSnapshot(docRef, (docSnap) => {
      if (docSnap.exists()) {
        setSettings(docSnap.data());
      } else {
        setSettings(null);
      }
      setLoading(false);
    }, (error) => {
      console.error("Error fetching MT4 settings:", error);
      setLoading(false);
    });

    return () => unsubscribe();
  }, [userId, isAuthReady]);

  const saveSettings = useCallback(async (newSettings) => {
    if (!db || !userId) return;
    const docRef = doc(db, MT4_SETTINGS_PATH(userId));
    try {
      await setDoc(docRef, newSettings, { merge: true });
      // Using console.log instead of alert to adhere to instructions
      console.log("MT4/MT5 settings saved successfully (Simulated).");
    } catch (e) {
      console.error("Error saving MT4 settings:", e);
    }
  }, [userId]);

  return { settings, loading, saveSettings };
};

// --- Components ---

const Notification = ({ children, type = 'info' }) => {
  const baseClasses = "p-4 mb-4 rounded-lg flex items-center shadow-lg";
  let colorClasses = "";

  switch (type) {
    case 'error':
      colorClasses = "bg-red-900 text-red-300";
      break;
    case 'success':
      colorClasses = "bg-green-800 text-green-300";
      break;
    case 'warning':
      colorClasses = "bg-yellow-800 text-yellow-300";
      break;
    case 'info':
    default:
      colorClasses = "bg-blue-800 text-blue-300";
  }

  return <div className={`${baseClasses} ${colorClasses}`}>{children}</div>;
};

const SignalRow = ({ signal, mt4Connected, autoTrade, handleTradeAction }) => {
  const isBuy = signal.type === 'BUY';
  
  // Updated statusColor to include TP/SL
  const statusColor = {
    NEW: 'bg-yellow-500',
    EXECUTED: 'bg-green-500',
    CONFIRMED: 'bg-indigo-500',
    DENIED: 'bg-red-500',
    HIT_TP: 'bg-cyan-500', // New color for TP
    HIT_SL: 'bg-pink-500', // New color for SL
  }[signal.status] || 'bg-gray-500';


  // Logic for the action/status display column
  let statusDisplay;

  if (signal.status === 'NEW') {
      // Action button or manual tag for new signals
      statusDisplay = mt4Connected
        ? (autoTrade
          ? <Zap className="w-5 h-5 text-green-500" title="Auto-executed" />
          : <button
            onClick={() => handleTradeAction(signal.id, 'CONFIRMED')}
            className="px-3 py-1 text-sm font-semibold rounded-full bg-indigo-600 hover:bg-indigo-700 transition duration-150"
          >
            Confirm Execute
          </button>
        ) : (
          <span className="text-gray-500 text-xs flex items-center">
            <Shield className="w-3 h-3 mr-1" /> Manual
          </span>
        );
  } else if (signal.status === 'HIT_TP') {
      statusDisplay = (
          <span className="text-cyan-400 text-sm font-bold flex items-center">
              <TrendingUp className="w-5 h-5 mr-1" /> TP HIT!
          </span>
      );
  } else if (signal.status === 'HIT_SL') {
      statusDisplay = (
          <span className="text-pink-400 text-sm font-bold flex items-center">
              <TrendingDown className="w-5 h-5 mr-1" /> SL HIT
          </span>
      );
  } else {
      // Default status tag (EXECUTED, CONFIRMED, DENIED)
      statusDisplay = (
        <div className="flex items-center space-x-1">
            <span className={`w-3 h-3 rounded-full ${statusColor}`}></span>
            <span className="text-xs font-medium text-gray-300">{signal.status}</span>
        </div>
      );
  }

  return (
    <div className="grid grid-cols-12 gap-2 p-4 border-b border-gray-700 hover:bg-gray-800 transition duration-150 items-center">
      {/* Pair & Timeframe */}
      <div className="col-span-3 font-bold text-lg flex items-center space-x-2">
        <span className={isBuy ? 'text-green-400' : 'text-red-400'}>
          {isBuy ? <ArrowUp className="w-5 h-5" /> : <ArrowDown className="w-5 h-5" />}
        </span>
        <span className="truncate">{signal.pair}</span>
        <span className="text-xs font-mono px-2 py-0.5 rounded bg-gray-600 text-gray-200">{signal.tf}</span>
      </div>

      {/* Entry / SL / TP */}
      <div className="col-span-4 text-sm font-mono space-y-1">
        <p className="flex justify-between">
          <span className="text-gray-400">Entry:</span>
          <span className="text-white font-semibold">{signal.entry}</span>
        </p>
        <p className="flex justify-between">
          <span className="text-red-400">SL (30 pips):</span>
          <span className="text-red-400">{signal.sl}</span>
        </p>
        <p className="flex justify-between">
          <span className="text-green-400">TP ({signal.tp === '200' ? '200' : '150'} pips):</span>
          <span className="text-green-400">{signal.tp}</span>
        </p>
      </div>

      {/* R:R Ratio & Strength */}
      <div className="col-span-2 text-center space-y-1">
        <p className="font-semibold text-white">1:{signal.r}</p>
        <p className={`text-xs font-medium px-2 py-0.5 rounded-full ${parseFloat(signal.r) >= 5 ? 'bg-emerald-800 text-emerald-300' : 'bg-orange-800 text-orange-300'}`}>
          High Prob.
        </p>
      </div>

      {/* Strength Bar */}
      <div className="col-span-1 flex flex-col items-center">
        <div className="text-xs text-gray-400 mb-1">{signal.strength}%</div>
        <div className="w-full h-2 bg-gray-600 rounded-full overflow-hidden">
          <div
            className="h-full bg-gradient-to-r from-yellow-400 to-green-500 transition-all duration-500"
            style={{ width: `${signal.strength}%` }}
          ></div>
        </div>
      </div>

      {/* Action / Status */}
      <div className="col-span-2 flex flex-col items-end space-y-2">
        {statusDisplay}
        <span className="text-xs text-gray-500">{signal.timestamp}</span>
      </div>
    </div>
  );
};

const MT4ConnectionModal = ({ mt4Settings, saveSettings, onClose }) => {
  const [login, setLogin] = useState(mt4Settings?.login || '');
  const [password, setPassword] = useState(mt4Settings?.password || '');
  const [server, setServer] = useState(mt4Settings?.server || '');
  const [autoTrade, setAutoTrade] = useState(mt4Settings?.autoTrade || false);
  const [telegramId, setTelegramId] = useState(mt4Settings?.telegramId || '');
  const [message, setMessage] = useState('');

  const handleSave = async () => {
    setMessage('');
    if (!login || !password || !server) {
      setMessage('Please fill in Login, Password, and Server details.');
      return;
    }

    const newSettings = { login, password, server, autoTrade, telegramId, connected: true };
    await saveSettings(newSettings);
    onClose();
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
      <div className="bg-gray-800 rounded-xl shadow-2xl p-6 w-full max-w-lg border border-indigo-600">
        <h2 className="text-2xl font-bold text-white mb-4 flex items-center">
          <Power className="w-6 h-6 mr-2 text-indigo-400" /> Connect MT4/MT5 Account
        </h2>
        <p className="text-sm text-gray-400 mb-6">
          <Eye className="w-4 h-4 inline mr-1" /> Connection is simulated. Credentials are securely stored in your private Firestore data.
        </p>

        {message && <Notification type="error">{message}</Notification>}

        <div className="space-y-4">
          <label className="block">
            <span className="text-gray-300 flex items-center"><User className="w-4 h-4 mr-2" /> Account Login:</span>
            <input
              type="text"
              className="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white"
              value={login}
              onChange={(e) => setLogin(e.target.value)}
            />
          </label>
          <label className="block">
            <span className="text-gray-300 flex items-center"><Shield className="w-4 h-4 mr-2" /> Password:</span>
            <input
              type="password"
              className="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
            />
          </label>
          <label className="block">
            <span className="text-gray-300 flex items-center"><Server className="w-4 h-4 mr-2" /> Server (e.g., BrokerName-Demo/Real):</span>
            <input
              type="text"
              className="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white"
              value={server}
              onChange={(e) => setServer(e.target.value)}
            />
          </label>

          <div className="flex justify-between items-center bg-gray-700 p-3 rounded-lg">
            <span className="text-gray-300 flex items-center"><Cpu className="w-4 h-4 mr-2" /> Enable Auto Execution:</span>
            <input
              type="checkbox"
              className="form-checkbox h-5 w-5 text-indigo-600 rounded border-gray-500 bg-gray-600"
              checked={autoTrade}
              onChange={(e) => setAutoTrade(e.target.checked)}
            />
          </div>

          <label className="block pt-2">
            <span className="text-gray-300 flex items-center"><Send className="w-4 h-4 mr-2" /> Telegram Chat ID (Optional for alerts):</span>
            <input
              type="text"
              placeholder="e.g., 123456789 (Simulated Integration)"
              className="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white"
              value={telegramId}
              onChange={(e) => setTelegramId(e.target.value)}
            />
          </label>
        </div>

        <div className="mt-6 flex justify-end space-x-3">
          <button
            onClick={onClose}
            className="px-4 py-2 text-gray-300 bg-gray-600 rounded-lg hover:bg-gray-700 transition"
          >
            Cancel
          </button>
          <button
            onClick={handleSave}
            className="px-4 py-2 text-white bg-indigo-600 rounded-lg font-semibold hover:bg-indigo-700 transition flex items-center"
          >
            <Power className="w-4 h-4 mr-2" /> {mt4Settings?.connected ? 'Update Connection' : 'Connect'}
          </button>
        </div>
      </div>
    </div>
  );
};

// --- Main Application Component ---

const App = () => {
  const { userId, isAuthReady, error, authInstance } = useFirebaseAuthState();
  const { settings: mt4Settings, loading: loadingMT4, saveSettings } = useMT4Settings(userId, isAuthReady);

  const [signals, setSignals] = useState([]);
  const [lastRefresh, setLastRefresh] = useState(null);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [isRefreshing, setIsRefreshing] = useState(false);

  const mt4Connected = mt4Settings?.connected && mt4Settings?.login;
  const autoTrade = mt4Settings?.autoTrade || false;

  // Function to simulate the backend signal generation/refresh and trade closure
  const refreshSignals = useCallback(async () => {
    if (isRefreshing) return;
    setIsRefreshing(true);
    // Simulate network delay
    await new Promise(resolve => setTimeout(resolve, 800));

    // 1. Process existing open signals (NEW, EXECUTED, CONFIRMED)
    setSignals(prevSignals => {
        // Filter signals into those that are closed (TP/SL/DENIED) and those that are open
        let openSignals = prevSignals.filter(s => s.status !== 'HIT_TP' && s.status !== 'HIT_SL' && s.status !== 'DENIED');
        let closedSignals = prevSignals.filter(s => s.status === 'HIT_TP' || s.status === 'HIT_SL' || s.status === 'DENIED');

        // Check if any active trade (EXECUTED or CONFIRMED) should be closed
        const updatedOpenSignals = openSignals.map(signal => {
            // 20% chance to close an active trade on this refresh cycle
            if (Math.random() < 0.20 && (signal.status === 'EXECUTED' || signal.status === 'CONFIRMED')) {
                const closureStatus = Math.random() > 0.5 ? 'HIT_TP' : 'HIT_SL';
                console.log(`SIMULATION: Signal ${signal.id} closed as ${closureStatus}.`);
                return { 
                    ...signal, 
                    status: closureStatus, 
                    timestamp: signal.timestamp, // Keep original entry time
                    closureTime: new Date().toLocaleTimeString() 
                };
            }
            return signal;
        });

        // 2. Generate new signals
        const newSignals = generateMockSignals(3);
        
        // 3. Simulated auto-execution check for NEW signals
        const readyNewSignals = newSignals.map(s => {
            if (mt4Connected && autoTrade && s.status === 'NEW') {
                return { ...s, status: 'EXECUTED' };
            }
            return s;
        });

        // Return all signals: closed, updated open, and newly generated.
        // Sort by the original timestamp to keep a chronological view (newest first).
        return [...closedSignals, ...updatedOpenSignals.filter(s => s.status !== 'HIT_TP' && s.status !== 'HIT_SL'), ...readyNewSignals]
            .sort((a, b) => {
                // Prioritize closed trades at the top for visibility, then sort by original timestamp
                const statusOrder = (status) => 
                    status === 'HIT_TP' ? 1 : 
                    status === 'HIT_SL' ? 2 : 3;

                const statusComparison = statusOrder(a.status) - statusOrder(b.status);
                if (statusComparison !== 0) return statusComparison;

                return new Date(b.timestamp) - new Date(a.timestamp); 
            });
    });

    setLastRefresh(new Date());
    setIsRefreshing(false);

  }, [mt4Connected, autoTrade, isRefreshing]);

  // Initial load and periodic refresh
  useEffect(() => {
    if (!isAuthReady || !userId) return;

    // Load initial signals
    refreshSignals();

    // Setup 30-second refresh interval
    const intervalId = setInterval(() => {
      refreshSignals();
    }, 30000); // 30 seconds

    return () => clearInterval(intervalId);
  }, [isAuthReady, userId, refreshSignals]);


  const handleTradeAction = (signalId, action) => {
    // Manually confirmed trades are set to CONFIRMED
    setSignals(prevSignals => prevSignals.map(s =>
      s.id === signalId && s.status === 'NEW' ? { ...s, status: action } : s
    ));
    // In a real app, this would trigger an execution order via the MT4/MT5 API
    console.log(`SIMULATION: Signal ${signalId} manually marked as ${action}.`);
  };

  const handleLogout = async () => {
    if (authInstance) {
      try {
        await signOut(authInstance);
        // The onAuthStateChanged listener will handle signing the user back in anonymously
      } catch (e) {
        console.error("Logout error:", e);
      }
    }
  };

  const renderStatus = () => {
    if (error) return <Notification type="error">{error}</Notification>;
    if (!isAuthReady || loadingMT4) return <Notification type="info" children={<>Loading configuration and user state...</>} />;
    if (!userId) return <Notification type="warning" children={<>Signing you in anonymously...</>} />;

    return (
      <div className="flex items-center space-x-4">
        <div className={`flex items-center text-sm px-3 py-1 rounded-full ${mt4Connected ? 'bg-green-700 text-green-200' : 'bg-red-700 text-red-200'}`}>
          <Power className="w-4 h-4 mr-2" />
          {mt4Connected ? (autoTrade ? 'MT4/MT5: Auto Trading ON' : 'MT4/MT5: Manual Execution') : 'MT4/MT5: Disconnected'}
        </div>
        <div className="text-sm text-gray-400 hidden sm:block">
          <User className="w-4 h-4 inline mr-1" /> User ID: <span className="font-mono text-xs">{userId}</span>
        </div>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-gray-900 text-gray-100 font-inter p-4 sm:p-8">
      {/* Header and Controls */}
      <header className="mb-8 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
        <h1 className="text-3xl font-extrabold text-indigo-400 flex items-center">
          <Signal className="w-8 h-8 mr-3" /> Forex Signal Analyzer
        </h1>
        <div className="flex space-x-3 items-center">
          {renderStatus()}
          <button
            onClick={() => setIsModalOpen(true)}
            className="p-3 rounded-full bg-indigo-600 hover:bg-indigo-700 transition duration-150 shadow-lg"
            title="MT4/MT5 Connection Settings"
          >
            <Settings className="w-5 h-5" />
          </button>
          <button
            onClick={handleLogout}
            className="p-3 rounded-full bg-red-600 hover:bg-red-700 transition duration-150 shadow-lg"
            title="Logout / Change User"
          >
            <LogOut className="w-5 h-5" />
          </button>
        </div>
      </header>

      {/* Control Panel and Status */}
      <div className="bg-gray-800 p-4 rounded-xl shadow-xl mb-6 flex justify-between items-center flex-wrap gap-4">
        <div className="text-sm text-gray-300 flex items-center space-x-2">
          <Repeat className="w-5 h-5 text-yellow-500" />
          <span>Last Scan: {lastRefresh ? lastRefresh.toLocaleTimeString() : 'N/A'}</span>
        </div>
        <button
          onClick={refreshSignals}
          disabled={isRefreshing}
          className="px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition disabled:bg-gray-600 disabled:cursor-not-allowed flex items-center"
        >
          {isRefreshing ? (
            <>
              <Loader2 className="w-4 h-4 mr-2 animate-spin" /> Scanning...
            </>
          ) : (
            <>
              <Repeat className="w-4 h-4 mr-2" /> Manual Scan
            </>
          )}
        </button>
        <div className="text-sm text-gray-300 flex items-center space-x-2">
          <Signal className="w-5 h-5 text-cyan-400" />
          <span>Analysis Timeframes: M30, H1, H4</span>
        </div>
      </div>

      {/* Signal Dashboard */}
      <div className="bg-gray-800 rounded-xl shadow-2xl overflow-hidden border border-gray-700">
        <div className="p-4 bg-gray-700 text-lg font-bold text-white flex justify-between items-center">
          <h2>High-Probability Signals (R:R $\ge$ 5:1)</h2>
          <span className="text-sm text-gray-400">Total Signals: {signals.length}</span>
        </div>

        {signals.length === 0 ? (
          <div className="p-12 text-center text-gray-500">
            <Signal className="w-12 h-12 mx-auto mb-4" />
            <p>No high-probability signals found in the last scan. Waiting for market structure and candlestick confirmation.</p>
          </div>
        ) : (
          <div className="divide-y divide-gray-700">
            {signals.map(signal => (
              <SignalRow
                key={signal.id}
                signal={signal}
                mt4Connected={mt4Connected}
                autoTrade={autoTrade}
                handleTradeAction={handleTradeAction}
              />
            ))}
          </div>
        )}
      </div>

      {/* Footer / Disclaimer */}
      <footer className="mt-8 text-center text-xs text-gray-500">
        <p>Disclaimer: This platform uses simulated data for Forex signal generation (Market Structure, Candlesticks, R:R $\ge$ 5:1). Live execution via MT4/MT5 is simulated for demonstration purposes only.</p>
        <p>Fixed parameters: SL $\approx$ 30 pips, TP $\approx$ 150-200 pips.</p>
      </footer>

      {/* MT4 Connection Modal */}
      {isModalOpen && (
        <MT4ConnectionModal
          mt4Settings={mt4Settings}
          saveSettings={saveSettings}
          onClose={() => setIsModalOpen(false)}
        />
      )}
    </div>
  );
};

export default App;
